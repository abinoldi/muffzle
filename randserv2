#!/usr/bin/env node

const { execSync } = require("child_process");
const fs = require("fs");
const readline = require("readline");
const os = require("os");

// --- CONFIGURATION ---
const MSRV_URL = "https://ghostbin.axel.org/paste/ohdym/raw";
const PLACE_ID = "121864768012064";

// STATUS MONITORING
const CHECK_SERVER_PRESENCE = false;
const AUTO_RECONNECT = false;     
const AUTO_RANDOM_CODE = false;

// --- GRID SETTINGS (XML) ---
const GRID_COLS = 3;
const BOX_SIZE = 150;
const START_OFFSET_Y = 50;
const GAP_X = 5;            
const GAP_Y = 60;

// --- TIMING & RETRY ---
const CHECK_INTERVAL = 60;
const POST_GAME_WAIT = 15000;
const MAX_FINAL_RETRIES = 3; // Batas maksimal mencoba ulang di fase akhir agar tidak infinite loop

function ensurePackage(pkg) {
  try { require.resolve(pkg); } 
  catch {
    try { execSync(`npm install ${pkg}`, { stdio: "inherit" }); } 
    catch (e) { process.exit(1); }
  }
}
["axios", "cli-table3"].forEach(ensurePackage);

const axios = require("axios");
const Table = require("cli-table3");

const TERMUX_PREFIX = "/data/data/com.termux/files/usr/bin";
const NODE_PATH = `${TERMUX_PREFIX}/node`;
const SQLITE_PATH = `${TERMUX_PREFIX}/sqlite3`;

let lastRestartMap = {};
let accountStates = {};

// --- PERFORMANCE BOOSTER ---
function applyPerformanceTweaks() {
  console.log("\nðŸš€ Menerapkan Tweak Performa (CPU, Thermal, UI)...");
  try {
      const tweaksCmd = `
          for i in {0..7}; do
              echo 1 > /sys/devices/system/cpu/cpu$i/online 2>/dev/null;
              echo performance > /sys/devices/system/cpu/cpu$i/cpufreq/scaling_governor 2>/dev/null;
          done;
          stop thermal-engine 2>/dev/null;
          stop thermald 2>/dev/null;
          killall -9 thermal-engine thermald 2>/dev/null;
          for tz in /sys/class/thermal/thermal_zone*/trip_point_*_temp; do
              [ -f "$tz" ] && echo 99999 > "$tz" 2>/dev/null;
          done;
          for dev in /sys/block/mmcblk[0-9]/queue/scheduler; do
              [ -f "$dev" ] && echo "deadline" > "$dev" 2>/dev/null;
          done;
          echo 10 > /proc/sys/vm/swappiness 2>/dev/null;
          settings put global window_animation_scale 0 2>/dev/null;
          settings put global transition_animation_scale 0 2>/dev/null;
          settings put global animator_duration_scale 0 2>/dev/null;
      `;
      execSync(`su -c '${tweaksCmd}'`, { stdio: 'ignore' });
      console.log("   âœ… Tweak Performa Aktif! (HP mungkin akan terasa lebih hangat)");
  } catch (e) {
      console.log("   âŒ Gagal menerapkan tweak performa: Pastikan script berjalan dengan Root.");
  }
}

// --- RESTORE SYSTEM PADA SAAT EXIT ---
function restoreSystemSettings() {
  console.log("\nâ™»ï¸ Mengembalikan Pengaturan Sistem (Pendingin & Animasi)...");
  try {
      const restoreCmd = `
          for i in {0..7}; do
              echo schedutil > /sys/devices/system/cpu/cpu$i/cpufreq/scaling_governor 2>/dev/null;
          done;
          start thermal-engine 2>/dev/null;
          settings put global window_animation_scale 1 2>/dev/null;
          settings put global transition_animation_scale 1 2>/dev/null;
          settings put global animator_duration_scale 1 2>/dev/null;
      `;
      execSync(`su -c '${restoreCmd}'`, { stdio: 'ignore' });
      execSync('termux-wake-unlock', { stdio: 'ignore' });
      console.log("   âœ… Sistem telah dikembalikan ke kondisi normal.");
  } catch (e) {}
}

process.on('SIGINT', () => {
  restoreSystemSettings();
  process.exit(0);
});

function initSystem() {
  try {
    const uid = execSync("id -u").toString().trim();
    if (uid !== "0") {
      const node = fs.existsSync(NODE_PATH) ? NODE_PATH : "node";
      const args = process.argv.slice(2).join(" ");
      execSync(`su -c "${node} ${__filename} ${args}"`, { stdio: "inherit" });
      process.exit(0);
    }
    try { execSync("termux-wake-lock"); } catch {}
  } catch (e) { process.exit(1); }
}

const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

const ask = (q) => new Promise(r => {
  const rl = readline.createInterface({ input: process.stdin, output: process.stdout });
  rl.question(q, (ans) => { rl.close(); r(ans); });
});

function getPackages() {
  try {
    return execSync("pm list packages | grep roblox", { encoding: "utf8" })
      .split("\n").filter(l => l.trim()).map(l => l.replace("package:", "").trim());
  } catch { return []; }
}

function getRobloxCookie(packageName) {
  try {
    const cookiesPath = `/data/data/${packageName}/app_webview/Default/Cookies`;
    const tempPath = `/sdcard/temp_cookie_${packageName}_${Date.now()}.db`;
    execSync(`cp "${cookiesPath}" "${tempPath}"`);
    const sqliteCmd = fs.existsSync(SQLITE_PATH) ? SQLITE_PATH : "sqlite3";
    const query = `${sqliteCmd} "${tempPath}" "SELECT value FROM cookies WHERE name = '.ROBLOSECURITY' LIMIT 1"`;
    let cookie = execSync(query).toString().trim();
    execSync(`rm "${tempPath}"`);
    if (cookie && !cookie.startsWith("_")) cookie = "_" + cookie;
    return cookie ? `.ROBLOSECURITY=${cookie}` : null;
  } catch { return null; }
}

async function getUserInfo(cookie) {
  if (!cookie) return { id: null, name: "No Cookie" };
  try {
    const res = await axios.get("https://users.roblox.com/v1/users/authenticated", {
      headers: { Cookie: cookie, "User-Agent": "Mozilla/5.0 (Android 10; Mobile)" }
    });
    return { id: res.data.id, name: res.data.name };
  } catch { 
    return { id: null, name: "Expired" };
  }
}

function stopPackage(pkg) {
  try { execSync(`am force-stop ${pkg}`, { stdio: 'ignore' });
  } catch (e) {} 
}

function releaseMemory() {
  try {
    execSync('su -c "sync; echo 3 > /proc/sys/vm/drop_caches"', { stdio: 'ignore' });
    return true;
  } catch (e) { return false; }
}

function autoArrangeXML(packages) {
  console.log(`\nðŸ“ Mengatur XML (Grid ${GRID_COLS}xN | Size ${BOX_SIZE} | Gap Y ${GAP_Y})...`);
  packages.sort();
  packages.forEach((pkg, index) => {
    const col = index % GRID_COLS;
    const row = Math.floor(index / GRID_COLS);

    const left = col * (BOX_SIZE + GAP_X);
    const top = (row * (BOX_SIZE + GAP_Y)) + START_OFFSET_Y;
    const right = left + BOX_SIZE;
    const bottom = top + BOX_SIZE;

    const prefsFile = `/data/data/${pkg}/shared_prefs/${pkg}_preferences.xml`;

    const cmd = `su -c "
      sed -i 's|app_cloner_current_window_left\\" value=\\"[0-9]*|app_cloner_current_window_left\\" value=\\"${left}|' ${prefsFile};
      sed -i 's|app_cloner_current_window_top\\" value=\\"[0-9]*|app_cloner_current_window_top\\" value=\\"${top}|' ${prefsFile};
      sed -i 's|app_cloner_current_window_right\\" value=\\"[0-9]*|app_cloner_current_window_right\\" value=\\"${right}|' ${prefsFile};
      sed -i 's|app_cloner_current_window_bottom\\" value=\\"[0-9]*|app_cloner_current_window_bottom\\" value=\\"${bottom}|' ${prefsFile};
      sed -i 's|<int name=\\"GraphicsQualityLevel\\" value=\\".*\\" />|<int name=\\"GraphicsQualityLevel\\" value=\\"1\\" />|g' ${prefsFile};
      chmod 660 ${prefsFile}
    "`;
    try { execSync(cmd, { stdio: 'ignore' }); } catch (e) {}
  });
  console.log("âœ… Posisi XML tersimpan dan Grafis dipaksa rata kiri.");
}

async function launchPackage(pkg, url) {
  try {
    const cmd = `am start -n ${pkg}/com.roblox.client.ActivityProtocolLaunch -a android.intent.action.VIEW -d "${url}"`;
    execSync(cmd, { stdio: 'ignore' });
  } catch (e) {}
}

async function fetchLinkCodes() {
  console.log("ðŸŒ Fetching codes...");
  try {
    const res = await axios.get(MSRV_URL);
    return res.data.split('\n').map(l => l.trim()).filter(l => l.length > 0);
  } catch (e) { return []; }
}

function getSystemStats() {
  const cpus = os.cpus();
  const idle = cpus.reduce((acc, cpu) => acc + cpu.times.idle, 0);
  const total = cpus.reduce((acc, cpu) => acc + cpu.times.user + cpu.times.nice + cpu.times.sys + cpu.times.irq + cpu.times.idle, 0);
  const cpuUsage = (100 - (idle / total) * 100).toFixed(1);
  const totalMem = os.totalmem();
  const totalGB = (totalMem / (1024 ** 3)).toFixed(2);
  const usedGB = ((totalMem - os.freemem()) / (1024 ** 3)).toFixed(2);
  const uptimeHrs = Math.floor(os.uptime() / 3600);
  return { cpu: `${cpuUsage}%`, ram: `${usedGB}/${totalGB} GB`, uptime: `${uptimeHrs}h` };
}

function renderDashboard(cleanCode, statusMessage) {
  console.clear();
  const stats = getSystemStats();
  console.log(`ðŸ“± SYSTEM: CPU ${stats.cpu} | RAM ${stats.ram} | UP ${stats.uptime} | BOOSTER: ON ðŸ”¥`);
  console.log(`ðŸ“ MODE: XML GRID (${GRID_COLS} cols) | GAP Y: ${GAP_Y}px`);
  console.log(`ðŸ“Š STATUS: ${statusMessage} | Mode: ONE-SHOT (No Loop) | Code: ${cleanCode}`);
  const termWidth = process.stdout.columns || 80;
  const safeWidth = Math.max(40, termWidth - 8); 

  const wPkg = Math.floor(safeWidth * 0.25);
  const wUser = Math.floor(safeWidth * 0.15);
  const wState = Math.floor(safeWidth * 0.15);
  const wStatus = Math.floor(safeWidth * 0.20);
  const wAction = Math.max(5, safeWidth - (wPkg + wUser + wState + wStatus));
  const table = new Table({ 
      head: ['Pkg', 'User', 'State', 'Status', 'Action'], 
      colWidths: [wPkg, wUser, wState, wStatus, wAction],
      wordWrap: true 
  });
  Object.keys(accountStates).sort().forEach(pkg => {
    const s = accountStates[pkg];
    table.push([
      pkg.replace("com.roblox.client", "...client"), 
      s.username.substring(0, 12),
      s.isRunning ? "Run ðŸŸ¢" : "Wait âšª",
      s.serverStatus,
      s.action
    ]);
  });
  console.log(table.toString());
}

function isAppRunning(pkg) {
  try {
    const output = execSync(`su -c "pidof ${pkg}"`, { encoding: 'utf8' }).trim();
    return output.length > 0;
  } catch (e) { return false; }
}

async function main() {
  initSystem();
  console.clear();
  console.log("ðŸš€ Initializing Manager (One-Shot Mode)...");

  // Aktifkan booster sebelum memulai eksekusi berat
  applyPerformanceTweaks();

  const packages = getPackages();
  if (!packages.length) { 
    console.log("âŒ No Roblox packages found."); 
    restoreSystemSettings();
    process.exit(0); 
  }

  let accounts = [];
  packages.sort();
  for (const pkg of packages) {
    process.stdout.write(`Reading ${pkg}... \r`);
    const cookie = getRobloxCookie(pkg);
    const userInfo = await getUserInfo(cookie);
    
    if (!userInfo.id || userInfo.name === "Expired") {
      console.log(`âš ï¸ Skipping ${pkg}: Cookie Expired atau Tidak Valid.`);
      continue; 
    }

    accounts.push({ pkg, cookie, userId: userInfo.id, username: userInfo.name });
    lastRestartMap[pkg] = 0;
    accountStates[pkg] = { username: userInfo.name, isRunning: false, serverStatus: "Waiting...", action: "-" };
  }

  if (accounts.length === 0) {
    console.log("âŒ Tidak ada akun valid untuk dijalankan.");
    restoreSystemSettings();
    process.exit(0);
  }

  console.log(`\nâœ… Loaded ${accounts.length} valid accounts.`);

  const codes = await fetchLinkCodes();
  if (codes.length === 0) { 
    console.log("âš ï¸ No codes found."); 
    restoreSystemSettings();
    process.exit(1);
  }

  // --- MODIFIKASI: ARGUMEN UNTUK SERVER 0 / NONE ---
  let cleanCode = "";
  if (!AUTO_RANDOM_CODE) {
    const argIndex = process.argv.indexOf("-server");
    let selectedIdx = -1;
    
    if (argIndex !== -1 && process.argv[argIndex + 1]) {
        if (process.argv[argIndex + 1] === "0") {
            cleanCode = "NONE";
        } else {
            selectedIdx = parseInt(process.argv[argIndex + 1]) - 1;
        }
    }

    if (cleanCode === "NONE") {
        console.log(`\nâœ… Auto-selecting Public Server (Tanpa Link Code).`);
    } else if (selectedIdx >= 0 && selectedIdx < codes.length) {
        console.log(`\nâœ… Auto-selecting Server [${selectedIdx + 1}] via arguments.`);
        cleanCode = codes[selectedIdx];
    } else {
        console.log("\nðŸ“œ Available Codes:");
        codes.forEach((code, index) => console.log(`[${index + 1}] ${code}`));
        
        const selection = await ask("\nðŸ‘‰ Choose Server (Ketik 0 untuk Public Server): ");
        if (selection.trim() === "0") {
            cleanCode = "NONE";
            console.log(`\nâœ… Memilih Public Server (Tanpa Link Code).`);
        } else {
            const idx = parseInt(selection) - 1;
            if (isNaN(idx) || idx < 0 || idx >= codes.length) {
                console.log("âŒ Invalid selection.");
                restoreSystemSettings();
                process.exit(1);
            }
            cleanCode = codes[idx];
        }
    }
  }

  autoArrangeXML(accounts.map(a => a.pkg));

  // --- FASE 1: PELUNCURAN BERURUTAN ---
  console.log("\nðŸš€ Launching valid instances (Fase 1)...");
  for (let i = 0; i < accounts.length; i++) {
    const acc = accounts[i];
    
    // --- MODIFIKASI: LOGIKA LINK URL ---
    let finalLaunchUrl = `roblox://placeID=${PLACE_ID}`;
    if (cleanCode !== "NONE") {
        let currentCode = AUTO_RANDOM_CODE ? codes[Math.floor(Math.random() * codes.length)] : cleanCode;
        if(currentCode.includes("linkCode=")) {
            currentCode = currentCode.split("linkCode=")[1].split("&")[0];
        }
        finalLaunchUrl += `&linkCode=${currentCode}`;
    }

    let isStable = false;

    while (!isStable) {
      stopPackage(acc.pkg); 
      releaseMemory();
      await sleep(1500); 

      await launchPackage(acc.pkg, finalLaunchUrl);
      lastRestartMap[acc.pkg] = Date.now();
      accountStates[acc.pkg].isRunning = true;
      accountStates[acc.pkg].serverStatus = "Launching...";
      
      let crashed = false;
      // Tunggu stabil selama 60 detik
      for (let sec = 1; sec <= 60; sec++) {
        let displayCode = cleanCode === "NONE" ? "PUBLIC SERVER" : (AUTO_RANDOM_CODE ? "RANDOM" : `...${cleanCode.slice(-4)}`);
        renderDashboard(displayCode, `â³ ${acc.username} Stabilizing... (${sec}/60s)`);
        await sleep(1000); 

        if (!isAppRunning(acc.pkg)) {
            accountStates[acc.pkg].serverStatus = "Force Close!";
            renderDashboard(displayCode, `âš ï¸ ${acc.username} Force Close di detik ${sec}! Membuka ulang...`);
            crashed = true;
            await sleep(3000); 
            break; 
        }
      }

      if (!crashed) {
        let displayCode = cleanCode === "NONE" ? "PUBLIC SERVER" : (AUTO_RANDOM_CODE ? "RANDOM" : `...${cleanCode.slice(-4)}`);
        accountStates[acc.pkg].serverStatus = "In Game ðŸŽ® (Stable)";
        renderDashboard(displayCode, `âœ… ${acc.username} Stabil selama 1 menit! Lanjut...`);
        isStable = true; 
        await sleep(2000); 
      }
    }
  }

  // --- FASE 2: PENGECEKAN AKHIR KESELURUHAN (FINAL CHECK) ---
  let allRunning = false;
  let retryCount = 0;

  while (!allRunning && retryCount < MAX_FINAL_RETRIES) {
    allRunning = true;
    for (let i = 0; i < accounts.length; i++) {
      const acc = accounts[i];
      // Jika ditemukan aplikasi yang mati di latar belakang
      if (!isAppRunning(acc.pkg)) {
        allRunning = false;
        
        let displayCode = cleanCode === "NONE" ? "PUBLIC SERVER" : (AUTO_RANDOM_CODE ? "RANDOM" : `...${cleanCode.slice(-4)}`);
        accountStates[acc.pkg].serverStatus = "Re-opening...";
        renderDashboard(displayCode, `ðŸ” Pengecekan Akhir: ${acc.username} Force Close! Membuka ulang...`);
        stopPackage(acc.pkg);
        releaseMemory();
        await sleep(1500);

        // --- MODIFIKASI: LOGIKA LINK URL DI FINAL CHECK ---
        let finalLaunchUrl = `roblox://placeID=${PLACE_ID}`;
        if (cleanCode !== "NONE") {
            let currentCode = AUTO_RANDOM_CODE ? codes[Math.floor(Math.random() * codes.length)] : cleanCode;
            if(currentCode.includes("linkCode=")) {
                currentCode = currentCode.split("linkCode=")[1].split("&")[0];
            }
            finalLaunchUrl += `&linkCode=${currentCode}`;
        }
        
        await launchPackage(acc.pkg, finalLaunchUrl);
        // Beri waktu 20 detik agar aplikasi baru ini masuk ke game
        for(let w = 1; w <= 20; w++) {
           renderDashboard(displayCode, `â³ Menunggu ${acc.username} re-open... (${w}/20s)`);
           await sleep(1000);
        }
        accountStates[acc.pkg].serverStatus = "In Game ðŸŽ® (Stable)";
      }
    }

    if (!allRunning) {
      retryCount++;
      if (retryCount < MAX_FINAL_RETRIES) {
        let displayCode = cleanCode === "NONE" ? "PUBLIC SERVER" : (AUTO_RANDOM_CODE ? "RANDOM" : `...${cleanCode.slice(-4)}`);
        renderDashboard(displayCode, `ðŸ”„ Mengulang pengecekan seluruh aplikasi (Percobaan ke-${retryCount})...`);
        await sleep(3000);
      }
    }
  }

  // --- KESIMPULAN ---
  let displayCodeFinal = cleanCode === "NONE" ? "PUBLIC SERVER" : (AUTO_RANDOM_CODE ? "RANDOM" : `...${cleanCode.slice(-4)}`);
  renderDashboard(displayCodeFinal, allRunning ? "âœ… SEMUA APLIKASI BERJALAN BERSAMAAN!" : `âš ï¸ Selesai. Beberapa app gagal karena limit RAM.`);
  
  console.log("\nðŸ§¹ Performing Final Memory Release...");
  releaseMemory();
  restoreSystemSettings();
  
  if (allRunning) {
      console.log("\nðŸŽ‰ [SUKSES] Seluruh akun berhasil diluncurkan dan bertahan.");
  } else {
      console.log("\nâš ï¸ [INFO] Limit device tercapai. Beberapa akun dimatikan otomatis oleh OS Android.");
  }
  
  console.log("ðŸ‘‹ Script exiting (One-Shot Mode).");
  process.exit(0);
}

main();
