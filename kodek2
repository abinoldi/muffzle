#!/data/data/com.termux/files/usr/bin/bash

# =============================================
# GOFILE INSTALLER (SDCARD / INTERNAL STORAGE VER)
# VERSION: ZIP EDITION (INSTALL ALL APKS)
# =============================================

# Konfigurasi
TARGET_URL="https://gofile.io/d/OGGtb3"
# Folder ini akan muncul di Internal Storage -> Download
STORAGE_DIR="/sdcard/Download/Gofile-Installer" 
ZIP_FILE="codexitil.zip"
WT_TOKEN="4fd6sg89d7s6"

# Warna
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# =============================================
# 1. CEK IZIN PENYIMPANAN (PENTING!)
# =============================================
setup_storage() {
    echo -e "${BLUE}[INFO]${NC} Memeriksa akses penyimpanan..."
    
    # Cek apakah folder /sdcard bisa diakses
    if ls /sdcard >/dev/null 2>&1; then
        echo -e "${GREEN}[OK]${NC} Akses penyimpanan diizinkan."
    else
        echo -e "${RED}[!]${NC} Termux belum punya izin akses memori!"
        echo -e "${YELLOW}Jendela popup akan muncul, pilih 'IZINKAN' / 'ALLOW'${NC}"
        termux-setup-storage
        sleep 5
        
        echo -e "${YELLOW}Tekan Enter jika sudah mengizinkan...${NC}"
        read temp
        
        if ! ls /sdcard >/dev/null 2>&1; then
            echo -e "${RED}[ERROR]${NC} Gagal akses memori. Script tidak bisa lanjut."
            exit 1
        fi
    fi
    
    # Buat folder tujuan
    if [[ ! -d "$STORAGE_DIR" ]]; then
        mkdir -p "$STORAGE_DIR"
        echo -e "${GREEN}[OK]${NC} Folder dibuat: $STORAGE_DIR"
    fi
}

check_deps() {
    local deps=("curl" "jq" "tsu" "unzip" "file")
    for dep in "${deps[@]}"; do
        if ! command -v "$dep" &>/dev/null; then
            echo -e "${BLUE}[INFO]${NC} Menginstall $dep..."
            pkg install -y "$dep" >/dev/null 2>&1
        fi
    done
}

# =============================================
# 2. LOGIC DOWNLOAD (PYTHON PORT)
# =============================================

get_account_token() {
    local response=$(curl -s -X POST "https://api.gofile.io/accounts" \
        -H "User-Agent: Mozilla/5.0" \
        -H "Content-Type: application/json")
    echo "$response" | jq -r '.data.token'
}

get_target_link() {
    local token="$1"
    local content_id=$(echo "$TARGET_URL" | grep -o '[^/]*$')
    
    # Menggunakan Header X-Website-Token (Anti-Limit)
    local response=$(curl -s "https://api.gofile.io/contents/$content_id?cache=true" \
        -H "Authorization: Bearer $token" \
        -H "Cookie: accountToken=$token" \
        -H "X-Website-Token: $WT_TOKEN" \
        -H "User-Agent: Mozilla/5.0")
        
    local status=$(echo "$response" | jq -r '.status')
    if [[ "$status" != "ok" ]]; then
        echo -e "${RED}[ERR]${NC} API Error: $status" >&2
        return 1
    fi
    
    # Cari file zip
    local link=$(echo "$response" | jq -r '.data.children | to_entries[] | .value | select(.name | endswith(".zip")) | .link' | head -n 1)
    echo "$link"
}

# =============================================
# 3. PROSES UTAMA
# =============================================

run_system() {
    clear
    echo -e "${BLUE}================================${NC}"
    echo -e "${GREEN}GOFILE INSTALLER - INSTALL ALL APKS${NC}"
    echo -e "${BLUE}================================${NC}\n"
    
    check_deps
    setup_storage
    
    cd "$STORAGE_DIR" || exit
    
    echo -e "${BLUE}[INFO]${NC} Lokasi Kerja: $STORAGE_DIR"
    
    # Hapus file lama biar bersih
    rm -f *.zip *.apk
    
    # --- Download ---
    echo -e "${BLUE}[INFO]${NC} Mendapatkan token..."
    local token=$(get_account_token)
    if [[ -z "$token" || "$token" == "null" ]]; then
        echo -e "${RED}[FAIL]${NC} Gagal koneksi ke Gofile."
        exit 1
    fi
    
    echo -e "${BLUE}[INFO]${NC} Mencari Link Download..."
    local link=$(get_target_link "$token")
    
    if [[ -z "$link" || "$link" == "null" ]]; then
        echo -e "${RED}[FAIL]${NC} Link tidak ditemukan otomatis."
        echo -e "${YELLOW}Masukkan Link Manual:${NC} "
        read link
        if [[ -z "$link" ]]; then exit 1; fi
    fi
    
    echo -e "${BLUE}[INFO]${NC} Mendownload ke Internal Storage..."
    curl -L "$link" --progress-bar \
        -H "Cookie: accountToken=$token" \
        -H "User-Agent: Mozilla/5.0" \
        -o "$ZIP_FILE"
        
    if [[ ! -f "$ZIP_FILE" ]]; then
        echo -e "${RED}[FAIL]${NC} Download Gagal."
        exit 1
    fi
    
    # --- Extract ZIP ---
    echo -e "${BLUE}[INFO]${NC} Mengekstrak file ZIP..."
    
    # Cek apakah file ZIP valid (pake unzip -t aja biar aman)
    if unzip -t "$ZIP_FILE" >/dev/null 2>&1; then
        unzip -o "$ZIP_FILE" -d ./ >/dev/null 2>&1
        if [[ $? -eq 0 ]]; then
            echo -e "${GREEN}[OK]${NC} Ekstraksi ZIP berhasil."
        else
            echo -e "${RED}[FAIL]${NC} Gagal mengekstrak ZIP."
            exit 1
        fi
    else
        echo -e "${RED}[FAIL]${NC} File ZIP corrupt atau tidak valid."
        exit 1
    fi
    
    # --- Cari semua APK ---
    local apks=($(ls *.apk 2>/dev/null | sort -V))
    local total_apks=${#apks[@]}
    
    if [[ $total_apks -eq 0 ]]; then
        echo -e "${RED}[FAIL]${NC} Tidak ada APK ditemukan."
        echo -e "${YELLOW}Isi folder:${NC}"
        ls -la
        exit 1
    fi
    
    echo -e "${GREEN}[OK]${NC} Ditemukan ${total_apks} APK:"
    for apk in "${apks[@]}"; do
        echo "   - $apk"
    done
    echo ""
    
    # --- Install SEMUA APK ---
    echo -e "${YELLOW}[!]${NC} Meminta akses Root untuk install ${total_apks} APK..."
    
    if ! command -v sudo &>/dev/null || ! sudo -n true 2>/dev/null; then
        echo -e "${RED}[FAIL]${NC} Akses Root tidak tersedia."
        echo -e "${GREEN}[TIP]${NC} File sudah tersimpan di: $STORAGE_DIR"
        echo -e "${GREEN}[TIP]${NC} Silakan install manual menggunakan File Manager."
        exit 0
    fi
    
    echo -e "${BLUE}[INFO]${NC} Mulai install ${total_apks} APK..."
    echo "----------------------------------------"
    
    local success=0
    local failed=0
    
    for apk in "${apks[@]}"; do
        echo -n "ðŸ“¦ Installing $apk... "
        if sudo pm install -r "$STORAGE_DIR/$apk" >/dev/null 2>&1; then
            echo -e "${GREEN}âœ“ BERHASIL${NC}"
            ((success++))
        else
            echo -e "${RED}âœ— GAGAL${NC}"
            ((failed++))
        fi
    done
    
    echo "----------------------------------------"
    echo -e "${GREEN}âœ… Installasi selesai!${NC}"
    echo -e "   Berhasil: ${GREEN}${success}${NC} APK"
    echo -e "   Gagal: ${RED}${failed}${NC} APK"
    echo ""
    echo -e "${BLUE}[INFO]${NC} File ZIP dan APK tersimpan di:"
    echo -e "   ${YELLOW}$STORAGE_DIR${NC}"
}

run_system
