#!/data/data/com.termux/files/usr/bin/bash

# ============================================
# ANDROID REMOTE CONTROLLER FOR TERMUX
# Version: 4.0 (Ultimate Fix)
# ============================================

# Konfigurasi
SERVER_URL="http://146.190.119.151:8000"  # GANTI DENGAN IP SERVER!
SLEEP_INTERVAL=30

# Warna
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m'
BOLD='\033[1m'

# ============================================
# VARIABEL GLOBAL
# ============================================

DEVICE_ID=""
HWID=""
DEVICE_NAME=""
HAS_SU=false

# ============================================
# FUNGSI CEK SU
# ============================================

check_su() {
    if command -v su &> /dev/null; then
        if su -c "id" &> /dev/null; then
            HAS_SU=true
            echo -e "${GREEN}[âœ“] Root access available${NC}"
        else
            echo -e "${YELLOW}[!] Root access not available${NC}"
        fi
    else
        echo -e "${YELLOW}[!] su not found${NC}"
    fi
}

# ============================================
# FUNGSI UTILITY
# ============================================

show_banner() {
    clear
    echo -e "${CYAN}${BOLD}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘   ANDROID REMOTE CONTROLLER v4.0    â•‘"
    echo "â•‘         ${WHITE}Ultimate Fix${CYAN}                â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

check_deps() {
    echo -e "${BLUE}[â€¢] Checking dependencies...${NC}"
    
    if ! command -v curl &> /dev/null; then
        echo -e "${YELLOW}[!] Installing curl...${NC}"
        pkg install curl -y > /dev/null 2>&1
    fi
    
    if ! command -v termux-toast &> /dev/null; then
        echo -e "${YELLOW}[!] termux-api not installed${NC}"
    fi
    
    check_su
    echo -e "${GREEN}[âœ“] Ready${NC}"
}

# ============================================
# FUNGSI INFORMASI DEVICE
# ============================================

get_hwid() {
    local hwid=""
    
    # Coba dari berbagai sumber
    if [ -f /data/data/com.termux/files/home/.termux/termux.properties ]; then
        hwid=$(md5sum /data/data/com.termux/files/home/.termux/termux.properties 2>/dev/null | cut -d' ' -f1)
    fi
    
    if [ -z "$hwid" ] && [ "$HAS_SU" = true ]; then
        hwid=$(su -c "getprop ro.serialno" 2>/dev/null | tr -d '\n\r')
    fi
    
    if [ -z "$hwid" ]; then
        hwid=$(cat /dev/urandom 2>/dev/null | tr -dc 'a-f0-9' | fold -w 16 | head -n 1)
    fi
    
    if [ -z "$hwid" ]; then
        hwid="ANDROID_$(date +%s)"
    fi
    
    echo "$hwid" | md5sum | cut -c1-16 | tr -d '\n'
}

get_device_name() {
    local name=""
    
    if command -v getprop &> /dev/null; then
        name=$(getprop ro.product.model 2>/dev/null | tr -d '\n\r')
    fi
    
    if [ -z "$name" ]; then
        name="Android_$(uname -n 2>/dev/null | cut -c1-8)"
    fi
    
    echo "$name"
}

get_android_version() {
    local ver=""
    if command -v getprop &> /dev/null; then
        ver=$(getprop ro.build.version.release 2>/dev/null | tr -d '\n\r')
    fi
    echo "${ver:-Unknown}"
}

get_ip() {
    local ip=""
    
    if command -v ip &> /dev/null; then
        local iface=$(ip route 2>/dev/null | grep default | head -1 | awk '{print $5}')
        if [ -n "$iface" ]; then
            ip=$(ip addr show "$iface" 2>/dev/null | grep -w inet | head -1 | awk '{print $2}' | cut -d/ -f1)
        fi
    fi
    
    echo "${ip:-0.0.0.0}"
}

# ============================================
# FUNGSI MONITORING (FIXED)
# ============================================

get_cpu() {
    if [ ! -f /proc/stat ]; then
        echo "0"
        return
    fi
    
    local cpu user nice system idle iowait irq softirq steal
    local total1=0 idle1=0 total2=0 idle2=0
    
    # Baca pertama
    read cpu user nice system idle iowait irq softirq steal < /proc/stat 2>/dev/null
    
    # Handle empty values
    user=${user:-0}
    nice=${nice:-0}
    system=${system:-0}
    idle=${idle:-0}
    iowait=${iowait:-0}
    irq=${irq:-0}
    softirq=${softirq:-0}
    steal=${steal:-0}
    
    total1=$((user + nice + system + idle + iowait + irq + softirq + steal))
    idle1=$((idle + iowait))
    
    sleep 1
    
    # Baca kedua
    read cpu user nice system idle iowait irq softirq steal < /proc/stat 2>/dev/null
    
    user=${user:-0}
    nice=${nice:-0}
    system=${system:-0}
    idle=${idle:-0}
    iowait=${iowait:-0}
    irq=${irq:-0}
    softirq=${softirq:-0}
    steal=${steal:-0}
    
    total2=$((user + nice + system + idle + iowait + irq + softirq + steal))
    idle2=$((idle + iowait))
    
    local diff_total=$((total2 - total1))
    local diff_idle=$((idle2 - idle1))
    
    if [ $diff_total -gt 0 ]; then
        local usage=$(( (diff_total - diff_idle) * 100 / diff_total ))
        echo "$usage"
    else
        echo "0"
    fi
}

get_memory() {
    if [ ! -f /proc/meminfo ]; then
        echo '{"total":0,"used":0,"free":0,"percent":0}'
        return
    fi
    
    local total=$(grep MemTotal /proc/meminfo 2>/dev/null | awk '{print $2}')
    local available=$(grep MemAvailable /proc/meminfo 2>/dev/null | awk '{print $2}')
    
    total=${total:-0}
    available=${available:-0}
    
    local used=$((total - available))
    local percent=0
    
    if [ $total -gt 0 ]; then
        percent=$((used * 100 / total))
    fi
    
    # Batasi range
    [ $percent -lt 0 ] && percent=0
    [ $percent -gt 100 ] && percent=100
    
    echo "{\"total\":$((total * 1024)),\"used\":$((used * 1024)),\"free\":$((available * 1024)),\"percent\":$percent}"
}

get_battery() {
    local percent=0
    local plugged="false"
    
    if command -v termux-battery-status &> /dev/null; then
        local json=$(termux-battery-status 2>/dev/null)
        if [ -n "$json" ]; then
            percent=$(echo "$json" | grep -o '"percentage":[0-9]*' | head -1 | cut -d':' -f2)
            local status=$(echo "$json" | grep -o '"plugged":"[^"]*"' | head -1 | cut -d'"' -f4)
            [ "$status" = "PLUGGED" ] && plugged="true"
        fi
    fi
    
    if [ "$percent" -eq 0 ] && [ -f /sys/class/power_supply/battery/capacity ]; then
        percent=$(cat /sys/class/power_supply/battery/capacity 2>/dev/null)
        percent=${percent:-0}
    fi
    
    echo "{\"percent\":$percent,\"power_plugged\":$plugged}"
}

get_storage() {
    local total=0 used=0 free=0 percent=0
    
    if command -v df &> /dev/null; then
        local path="/sdcard"
        [ -d "$path" ] || path="/data"
        
        local df_out=$(df -k "$path" 2>/dev/null | tail -1)
        if [ -n "$df_out" ]; then
            total=$(echo "$df_out" | awk '{print $2}')
            used=$(echo "$df_out" | awk '{print $3}')
            free=$(echo "$df_out" | awk '{print $4}')
            percent=$(echo "$df_out" | awk '{print $5}' | tr -d '%')
        fi
    fi
    
    total=${total:-0}
    used=${used:-0}
    free=${free:-0}
    percent=${percent:-0}
    
    echo "{\"total\":$((total * 1024)),\"used\":$((used * 1024)),\"free\":$((free * 1024)),\"percent\":$percent}"
}

# ============================================
# FUNGSI KOMUNIKASI
# ============================================

send_metrics() {
    local timestamp=$(date +"%Y-%m-%dT%H:%M:%S%z")
    local cpu=$(get_cpu)
    local mem=$(get_memory)
    local batt=$(get_battery)
    local storage=$(get_storage)
    local ip=$(get_ip)
    local android=$(get_android_version)
    
    # Extract untuk display
    local mem_percent=$(echo "$mem" | grep -o '"percent":[0-9]*' | cut -d':' -f2)
    local batt_percent=$(echo "$batt" | grep -o '"percent":[0-9]*' | cut -d':' -f2)
    
    mem_percent=${mem_percent:-0}
    batt_percent=${batt_percent:-0}
    
    # Build JSON (tanpa newline)
    local json="{\"device_id\":\"$DEVICE_ID\",\"hwid\":\"$HWID\",\"device_name\":\"$DEVICE_NAME\",\"android_version\":\"$android\",\"timestamp\":\"$timestamp\",\"ip_address\":\"$ip\",\"cpu\":{\"usage_percent\":$cpu},\"memory\":$mem,\"storage\":$storage,\"battery\":$batt}"
    
    # Kirim
    if curl -s --max-time 5 -X POST "$SERVER_URL/api/metrics" \
        -H "Content-Type: application/json" \
        -d "$json" > /dev/null 2>&1; then
        echo -e "${GREEN}[$(date +%H:%M:%S)]${NC} âœ“ CPU: ${YELLOW}${cpu}%${NC} RAM: ${YELLOW}${mem_percent}%${NC} Batt: ${YELLOW}${batt_percent}%${NC}"
    else
        echo -e "${RED}[$(date +%H:%M:%S)]${NC} âœ— Server unreachable"
    fi
}

check_commands() {
    local response=$(curl -s --max-time 3 "$SERVER_URL/api/device/$DEVICE_ID/commands" 2>/dev/null)
    
    # Hapus quotes dari response
    response=$(echo "$response" | tr -d '"')
    
    if [ -n "$response" ] && [ "$response" != "null" ]; then
        local cmd=$(echo "$response" | cut -d':' -f1)
        local param=$(echo "$response" | cut -d':' -f2-)
        
        echo -e "${PURPLE}[$(date +%H:%M:%S)]${NC} Command: ${CYAN}$cmd${NC}"
        
        case "$cmd" in
            toast)
                if command -v termux-toast &> /dev/null; then
                    termux-toast "$param" > /dev/null 2>&1
                    echo -e "${GREEN}    âœ“ Toast: $param${NC}"
                fi
                ;;
                
            vibrate)
                if command -v termux-vibrate &> /dev/null; then
                    local dur=${param:-1000}
                    termux-vibrate -d "$dur" > /dev/null 2>&1
                    echo -e "${GREEN}    âœ“ Vibrate${NC}"
                fi
                ;;
                
            shell)
                echo -e "${YELLOW}    Exec: $param${NC}"
                local result=$(eval "$param" 2>&1)
                echo "$result" | head -3 | while read line; do
                    echo -e "${WHITE}      $line${NC}"
                done
                curl -s -X POST "$SERVER_URL/api/device/$DEVICE_ID/command_result" \
                    -H "Content-Type: text/plain" \
                    -d "$result" > /dev/null 2>&1
                ;;
                
            screenshot)
                if command -v termux-screenshot &> /dev/null; then
                    termux-screenshot > /dev/null 2>&1
                    echo -e "${GREEN}    âœ“ Screenshot${NC}"
                fi
                ;;
                
            reboot|reboot_now)
                local delay=3
                [ "$cmd" = "reboot" ] && delay=${param:-5}
                
                echo -e "${RED}${BOLD}    âš ï¸ REBOOT in ${delay}s${NC}"
                for ((i=delay; i>0; i--)); do
                    echo -e "${YELLOW}      $i...${NC}"
                    [ -x "$(command -v termux-toast)" ] && termux-toast "Reboot in $i" > /dev/null 2>&1
                    sleep 1
                done
                
                curl -s -X POST "$SERVER_URL/api/device/$DEVICE_ID/offline" > /dev/null 2>&1
                echo -e "${RED}    ğŸ’¥ REBOOT${NC}"
                exit 0
                ;;
                
            ping)
                curl -s -X POST "$SERVER_URL/api/device/$DEVICE_ID/command_result" \
                    -H "Content-Type: text/plain" \
                    -d "pong" > /dev/null 2>&1
                echo -e "${GREEN}    âœ“ Pong${NC}"
                ;;
                
            *)
                echo -e "${RED}    âœ— Unknown: $cmd${NC}"
                ;;
        esac
    fi
}

register() {
    echo -e "${BLUE}[â€¢] Registering...${NC}"
    
    local json="{\"hwid\":\"$HWID\",\"device_name\":\"$DEVICE_NAME\",\"device_id\":\"$DEVICE_ID\",\"android_version\":\"$(get_android_version)\",\"ip_address\":\"$(get_ip)\"}"
    
    if curl -s --max-time 5 -X POST "$SERVER_URL/register_device" \
        -H "Content-Type: application/json" \
        -d "$json" > /dev/null 2>&1; then
        echo -e "${GREEN}[âœ“] Registered${NC}"
    else
        echo -e "${YELLOW}[!] Register failed${NC}"
    fi
}

cleanup() {
    echo -e "\n${YELLOW}[!] Stopping...${NC}"
    curl -s --max-time 2 -X POST "$SERVER_URL/api/device/$DEVICE_ID/offline" > /dev/null 2>&1
    echo -e "${GREEN}[âœ“] Bye!${NC}"
    exit 0
}

# ============================================
# MAIN
# ============================================

trap cleanup SIGINT SIGTERM

show_banner
check_deps

HWID=$(get_hwid)
DEVICE_NAME=$(get_device_name)
DEVICE_ID="${DEVICE_NAME}_${HWID}"

echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${WHITE}Device:${NC}  $DEVICE_NAME"
echo -e "${WHITE}HWID:${NC}    $HWID"
echo -e "${WHITE}Android:${NC} $(get_android_version)"
echo -e "${WHITE}IP:${NC}      $(get_ip)"
echo -e "${WHITE}Server:${NC}  $SERVER_URL"
echo -e "${WHITE}SU:${NC}      $([ "$HAS_SU" = true ] && echo "${GREEN}Yes${NC}" || echo "${YELLOW}No${NC}")"
echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

register

echo -e "${YELLOW}[+] Starting monitoring...${NC}"
echo -e "${PURPLE}Press Ctrl+C to stop${NC}"
echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

while true; do
    send_metrics
    check_commands
    sleep $SLEEP_INTERVAL
done
