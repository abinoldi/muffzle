#!/bin/bash

# ============================================
# SUPER POTATO SCRIPT - Codex APK Optimizer
# ============================================

# Warna untuk output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Konfigurasi
TARGET_DIR="/storage/emulated/0/Download/Codex V2.708.880"
URL_TTF="http://43.134.116.2:5555/uploaded/bitmap.ttf"
URL_OTF="http://43.134.116.2:5555/uploaded/bitmap.otf"

# File log
LOG_FILE="$TARGET_DIR/super_potato_log.txt"

# ============================================
# Fungsi Utility
# ============================================

print_header() {
    echo -e "${BLUE}"
    echo "╔════════════════════════════════════════════════╗"
    echo "║         SUPER POTATO SCRIPT - CODEX           ║"
    echo "╚════════════════════════════════════════════════╝"
    echo -e "${NC}"
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
    echo "[SUCCESS] $(date): $1" >> "$LOG_FILE"
}

print_info() {
    echo -e "${BLUE}ℹ${NC} $1"
    echo "[INFO] $(date): $1" >> "$LOG_FILE"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
    echo "[WARNING] $(date): $1" >> "$LOG_FILE"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
    echo "[ERROR] $(date): $1" >> "$LOG_FILE"
}

check_target_dir() {
    if [ ! -d "$TARGET_DIR" ]; then
        print_error "Directory $TARGET_DIR tidak ditemukan!"
        exit 1
    fi
    print_success "Target directory ditemukan"
}

# ============================================
# Fungsi Utama
# ============================================

backup_important_files() {
    print_info "Membuat backup file penting..."
    
    BACKUP_DIR="$TARGET_DIR/BACKUP_$(date +%Y%m%d_%H%M%S)"
    mkdir -p "$BACKUP_DIR"
    
    # Backup AndroidManifest.xml dan META-INF
    cp "$TARGET_DIR/AndroidManifest.xml" "$BACKUP_DIR/" 2>/dev/null
    cp -r "$TARGET_DIR/META-INF" "$BACKUP_DIR/" 2>/dev/null
    cp "$TARGET_DIR/resources.arsc" "$BACKUP_DIR/" 2>/dev/null
    
    # Backup classes.dex
    cp "$TARGET_DIR/"classes*.dex "$BACKUP_DIR/" 2>/dev/null
    
    # Backup library penting
    mkdir -p "$BACKUP_DIR/lib"
    cp "$TARGET_DIR/lib/arm64-v8a/libroblox.so" "$BACKUP_DIR/lib/" 2>/dev/null
    cp "$TARGET_DIR/lib/arm64-v8a/libloader.so" "$BACKUP_DIR/lib/" 2>/dev/null
    cp "$TARGET_DIR/lib/arm64-v8a/libbacktrace-native.so" "$BACKUP_DIR/lib/" 2>/dev/null
    
    print_success "Backup disimpan di: $BACKUP_DIR"
}

remove_assets() {
    print_info "Menghapus aset-aset besar..."
    
    # 1. Hapus font (kecuali yang akan diganti)
    print_info "Menghapus font original..."
    rm -rf "$TARGET_DIR/assets/android/fonts/"*
    rm -rf "$TARGET_DIR/assets/content/fonts/"*
    print_success "Font original dihapus"
    
    # 2. Download font bitmap
    print_info "Mendownload font bitmap..."
    mkdir -p "$TARGET_DIR/assets/android/fonts"
    mkdir -p "$TARGET_DIR/assets/content/fonts"
    
    curl -L "$URL_TTF" -o "$TARGET_DIR/assets/android/fonts/bitmap.ttf" 2>/dev/null
    curl -L "$URL_OTF" -o "$TARGET_DIR/assets/content/fonts/bitmap.otf" 2>/dev/null
    
    if [ -f "$TARGET_DIR/assets/android/fonts/bitmap.ttf" ]; then
        print_success "Font bitmap.ttf downloaded"
    else
        print_warning "Gagal download bitmap.ttf"
    fi
    
    if [ -f "$TARGET_DIR/assets/content/fonts/bitmap.otf" ]; then
        print_success "Font bitmap.otf downloaded"
    else
        print_warning "Gagal download bitmap.otf"
    fi
    
    # 3. Hapus shaders
    print_info "Menghapus shaders..."
    rm -f "$TARGET_DIR/assets/shaders/"*.pack
    print_success "Shaders dihapus"
    
    # 4. Hapus models
    print_info "Menghapus models 3D..."
    rm -rf "$TARGET_DIR/assets/ExtraContent/models/"*
    rm -rf "$TARGET_DIR/assets/content/models/"*
    print_success "Models dihapus"
    
    # 5. Hapus textures resolusi tinggi
    print_info "Menghapus textures..."
    rm -rf "$TARGET_DIR/assets/ExtraContent/textures/"
    rm -rf "$TARGET_DIR/assets/content/textures/"
    rm -rf "$TARGET_DIR/assets/android/textures/"
    rm -rf "$TARGET_DIR/assets/content/sky/"
    print_success "Textures dihapus"
    
    # 6. Hapus sound
    print_info "Menghapus sound files..."
    rm -f "$TARGET_DIR/assets/content/sounds/"*.{ogg,mp3}
    print_success "Sound dihapus"
    
    # 7. Hapus ML models
    print_info "Menghapus ML models..."
    rm -rf "$TARGET_DIR/assets/mlkit_barcode_models/"
    print_success "ML models dihapus"
    
    # 8. Hapus LuaPackages (UI assets)
    print_info "Menghapus UI assets..."
    rm -rf "$TARGET_DIR/assets/ExtraContent/LuaPackages/Packages/"
    print_success "UI assets dihapus"
    
    # 9. Hapus folder random
    print_info "Menghapus folder acak..."
    rm -rf "$TARGET_DIR/assets/j1O1pP4cpnaLPxs2xoSf/"
    print_success "Folder acak dihapus"
}

clean_libraries() {
    print_info "Membersihkan library yang tidak penting..."
    
    LIB_DIR="$TARGET_DIR/lib/arm64-v8a"
    
    if [ -d "$LIB_DIR" ]; then
        # Daftar library yang akan dihapus
        declare -a libs_to_remove=(
            "libbarhopper_v3.so"
            "libzstd-jni-1.5.7-6.so"
            "librenderscript-toolkit.so"
            "libimage_processing_util_jni.so"
            "libdatastore_shared_counter.so"
            "libtrampoline.so"
            "libsurface_util_jni.so"
            "libyuv_shared.so"
            "libeigen_blas.so"
            "libeigen_lapack.so"
        )
        
        for lib in "${libs_to_remove[@]}"; do
            if [ -f "$LIB_DIR/$lib" ]; then
                rm -f "$LIB_DIR/$lib"
                print_success "Removed: $lib"
            fi
        done
        
        # Verifikasi library penting masih ada
        print_info "Memverifikasi library penting..."
        declare -a important_libs=(
            "libroblox.so"
            "libloader.so"
            "libbacktrace-native.so"
        )
        
        for lib in "${important_libs[@]}"; do
            if [ ! -f "$LIB_DIR/$lib" ]; then
                print_warning "Library penting hilang: $lib"
            else
                print_success "Library penting OK: $lib"
            fi
        done
    fi
}

clean_resources() {
    print_info "Membersihkan folder resources..."
    
    # Hapus semua folder drawable-* kecuali drawable/
    find "$TARGET_DIR/res" -maxdepth 1 -type d -name "drawable-*" -exec rm -rf {} \; 2>/dev/null
    
    # Hapus folder mipmap kecuali mipmap-anydpi-v26
    find "$TARGET_DIR/res" -maxdepth 1 -type d -name "mipmap-*" ! -name "mipmap-anydpi-v26" -exec rm -rf {} \; 2>/dev/null
    
    print_success "Resources dibersihkan"
}

show_size_reduction() {
    print_info "Menghitung ukuran akhir..."
    
    if [ -d "$TARGET_DIR" ]; then
        TOTAL_SIZE=$(du -sh "$TARGET_DIR" | cut -f1)
        print_success "Ukuran total direktori: $TOTAL_SIZE"
        
        # Hitung ukuran file-file penting
        DEX_SIZE=$(du -ch "$TARGET_DIR/"classes*.dex 2>/dev/null | grep total | cut -f1)
        LIB_SIZE=$(du -sh "$TARGET_DIR/lib/arm64-v8a" 2>/dev/null | cut -f1)
        
        echo -e "\n${YELLOW}=== Rincian Ukuran ===${NC}"
        echo "Classes DEX: $DEX_SIZE"
        echo "Libraries: $LIB_SIZE"
        echo "Total: $TOTAL_SIZE"
    fi
}

create_install_script() {
    print_info "Membuat script instalasi..."
    
    cat > "$TARGET_DIR/install.sh" << 'EOF'
#!/bin/bash
echo "Installing Super Potato Codex..."
echo "Pastikan Anda sudah meng-uninstall versi lama Codex"
echo "Tekan Enter untuk melanjutkan..."
read

# Hapus META-INF sementara untuk signing ulang (optional)
# mv META-INF META-INF.bak

echo "Done! Sekarang Anda perlu signing ulang APK ini."
echo "Gunakan APK Editor atau MT Manager untuk signing."
EOF
    
    chmod +x "$TARGET_DIR/install.sh"
    print_success "Script instalasi dibuat: install.sh"
}

# ============================================
# Main Execution
# ============================================

clear
print_header

# Cek directory
check_target_dir

# Initialize log
echo "=== SUPER POTATO LOG $(date) ===" > "$LOG_FILE"
echo "Target: $TARGET_DIR" >> "$LOG_FILE"
echo "" >> "$LOG_FILE"

# Konfirmasi
echo -e "${YELLOW}⚠ PERINGATAN: Script ini akan menghapus banyak file!${NC}"
echo "Target directory: $TARGET_DIR"
echo -n "Lanjutkan? (y/N): "
read confirm

if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
    print_info "Dibatalkan oleh user"
    exit 0
fi

# Backup
echo ""
backup_important_files

# Eksekusi pembersihan
echo ""
remove_assets

echo ""
clean_libraries

echo ""
clean_resources

echo ""
create_install_script

# Tampilkan hasil
echo ""
show_size_reduction

echo ""
print_success "SUPER POTATO COMPLETE!"
print_info "Log file: $LOG_FILE"
print_info "Backup: $BACKUP_DIR"
print_warning "CATATAN: APK ini PERLU di-sign ulang sebelum diinstall!"
print_warning "File backup penting ada di folder BACKUP_*"

echo ""
echo -e "${YELLOW}=== INSTRUKSI SELANJUTNYA ===${NC}"
echo "1. Buka folder: cd \"$TARGET_DIR\""
echo "2. Untuk menginstall, Anda perlu:"
echo "   - Sign ulang APK menggunakan MT Manager / APK Editor"
echo "   - Atau gunakan apktool untuk rebuild dan sign"
echo "3. File backup penting ada di folder BACKUP_* jika diperlukan"
echo ""
