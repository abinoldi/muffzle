#!/bin/bash

# ==========================================
# ROBLOX POTATO MODE (V6 - STRICT FORMAT MATCH)
# Target: /storage/emulated/0/Download/Codex V2.708.880/
# ==========================================

TARGET_DIR="/storage/emulated/0/Download/Codex V2.708.880"

# URL SUMBER
URL_TTF="http://43.134.116.2:5555/uploaded/bitmap.ttf"
URL_OTF="http://43.134.116.2:5555/uploaded/bitmap.otf"

# LOKASI PENYIMPANAN SEMENTARA
SRC_TTF="$TARGET_DIR/potato.ttf"
SRC_OTF="$TARGET_DIR/potato.otf"

echo -e "\033[1;36m"
echo "========================================"
echo "   üî• POTATO MODE V6 (MATCH EXTENSION) üî•"
echo "========================================"
echo -e "\033[0m"

# 1. CEK FOLDER TARGET
if [ ! -d "$TARGET_DIR" ]; then
    echo -e "\033[1;31m‚ùå Error: Folder Codex tidak ditemukan!\033[0m"
    exit 1
fi

# 2. DOWNLOAD KEDUA JENIS FONT
echo -e "\033[1;33m[*] Mendownload bahan font...\033[0m"

# Download TTF
if command -v curl &> /dev/null; then
    curl -L -o "$SRC_TTF" "$URL_TTF"
    curl -L -o "$SRC_OTF" "$URL_OTF"
else
    wget -O "$SRC_TTF" "$URL_TTF"
    wget -O "$SRC_OTF" "$URL_OTF"
fi

# Validasi Download
size_ttf=$(stat -c%s "$SRC_TTF" 2>/dev/null || echo 0)
size_otf=$(stat -c%s "$SRC_OTF" 2>/dev/null || echo 0)

if [ "$size_ttf" -lt 1000 ] || [ "$size_otf" -lt 1000 ]; then
    echo -e "\033[1;31m[GAGAL] Salah satu file font gagal didownload!\033[0m"
    echo "Cek koneksi internet atau linknya."
    exit 1
else
    echo -e "\033[1;32m[OK] Bahan font siap: TTF & OTF.\033[0m"
fi

# ==========================================
# 3. LOGIKA PROTEKSI (WHITELIST)
# ==========================================

should_skip() {
    local fname=$1
    local lower=$(echo "$fname" | tr '[:upper:]' '[:lower:]')

    # PROTEKSI AGAR TIDAK BLANK SCREEN
    if [[ "$lower" == *"sky"* ]] || \
       [[ "$lower" == *"login"* ]] || \
       [[ "$lower" == *"signin"* ]] || \
       [[ "$lower" == *"auth"* ]] || \
       [[ "$lower" == *"loading"* ]] || \
       [[ "$lower" == *"luaapp"* ]]; then
        return 0 # SKIP
    fi
    
    if [[ "$lower" == *"appicon"* ]] || [[ "$lower" == *"launcher"* ]]; then return 0; fi

    return 1 # PROSES
}

# ==========================================
# 4. PROSES REPLACE (SESUAI JENIS FILE)
# ==========================================

replace_matching_font() {
    local ext=$1      # e.g., .ttf
    local source=$2   # e.g., potato.ttf

    echo -e "\n\033[1;34m[*] Memproses Font tipe $ext ...\033[0m"
    
    find "$TARGET_DIR" -type f -name "*$ext" | while read -r filepath; do
        filename=$(basename "$filepath")
        
        # Jangan replace file sumber kita sendiri
        if [[ "$filename" == "potato.ttf" ]] || [[ "$filename" == "potato.otf" ]]; then continue; fi

        # --- PROTEKSI FONT SISTEM (SourceSans/Roblox) ---
        # Tetap dilindungi agar UI Chat & Menu tidak hilang
        if [[ "$filename" == *"SourceSans"* ]] || \
           [[ "$filename" == *"Roblox"* ]] || \
           [[ "$filename" == *"Arial"* ]]; then
             echo -e "   üõ°Ô∏è  \033[1;30m[SKIP] $filename (Font Sistem)\033[0m"
             continue
        fi

        # REPLACE
        # Kita copy source file (ttf ke ttf, otf ke otf)
        cp -f "$source" "$filepath"
        echo -e "   ‚úÖ Replaced: $filename (pake $(basename $source))"
    done
}

# ==========================================
# 5. PROSES KILL TEXTURE (TETAP SAMA)
# ==========================================

kill_texture() {
    local ext=$1
    echo -e "\n\033[1;31m[*] Membantai Texture 3D ($ext) ...\033[0m"
    find "$TARGET_DIR" -type f -name "*$ext" | while read -r filepath; do
        filename=$(basename "$filepath")
        
        if should_skip "$filename"; then
             if [[ "$filename" == *"sky"* ]]; then echo -e "   üõ°Ô∏è  [SAFE] $filename"; fi
             continue
        fi
        
        size=$(stat -c%s "$filepath")
        if [ "$size" -gt 0 ]; then
            rm "$filepath"
      
